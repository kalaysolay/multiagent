```asciidoc
= UC: Скрыть статью на портале

Цель::
Скрыть выбранную статью в публичном каталоге и поиске Портала ЕБЗ.

Акторы::
- **Редактор** – пользователь системы с правом редактирования статей (главный актор).

Границы системы::
. Основной поток: 
  1. Открытие административного центра.  
  2. Выбор статьи из списка.  
  3. Установка флага «Скрыть на портале».  
  4. Сохранение изменений.  
  5. Обновление индекса видимости и инвалидация кеша.  
  6. Подтверждение успешного выполнения.
. Обрабатываемые ошибки: 
  * Статья имеет статус, отличный от «Активна».  
  * Флаг уже установлен (статья уже скрыта).  
  * Ошибка обновления индекса видимости в подсистеме публикаций.

[%%collapsible]
.Диаграмма
====
[plantuml]
@startuml uc_articleVisibility
skinparam WrapWidth 200
usecase "Скрыть статью на портале" as hideArticle << base >>
actor "Редактор" as editor << user >>
editor -- hideArticle
hideArticle ..> openAdminCenter : include
@enduml
====
 
Предусловия::
1. Пользователь имеет роль **Редактор** (доступен только этому роли).  
2. Система находится в рабочем состоянии, административный центр доступен, статья существует в базе с статусом «Активна».

Успешный результат::
Статья помечена флагом *hideFlag = true*, индекс видимости обновлён (visible = false), кеш инвалидаирован, запись в журнале аудита создана; статья больше не появляется в результатах поиска и в рубрикаторе Портала ЕБЗ.

Возможные ошибки::
* **400 – Bad Request** – «Статья должна быть в статусе «Активна» для скрытия».  
* **409 – Conflict** – «Статья уже скрыта».  
* **500 – Internal Server Error** – «Не удалось обновить индекс видимости».

Триггер::
Редактор нажимает кнопку «Сохранить» после установки галочки «Скрыть на портале» в форме редактирования статьи.

== Основной сценарий  

[NOTE] Шаги нумеруются с интервалом 10, начиная с 10.

* **ШАГ 10** – *Открыть административный центр*  
  Editor → AdminCenter (boundary) : открыть центр администрирования.  
  AdminCenter → UI : отобразить список статей.

* **ШАГ 20** – *Выбрать статью*  
  Editor → AdminCenter : выбрать нужную запись в списке.  
  AdminCenter → ArticleController (control) : запросить детали статьи.  
  ArticleController → Article (entity) : загрузить сущность статьи.

* **ШАГ 30** – *Установить флаг «Скрыть на портале»*  
  Editor → ArticleForm (boundary) : отметить галочку hideFlag.  
  ArticleForm → UI : отразить изменение в модели представления.

* **ШАГ 40** – *Сохранить изменения*  
  Editor → ArticleForm : нажать кнопку «Сохранить».  
  ArticleForm → ArticleService (control) : вызвать `установитьФлагСкрытия()` и `сохранить()`.  
  ArticleService → Article (entity) : установить `hideFlag = true` и выполнить `сохранить()`.

* **ШАГ 50** – *Обновить индекс видимости*  
  ArticleService → PublicationSubsystem (control) : `обновитьИндексВидимости(articleId, false)`.  
  PublicationSubsystem → VisibilityIndex (entity) : установить `visible = false`.  
  PublicationSubsystem → CacheManager (control) : инвалидация кеша (см. расширение Р‑60.1).  
  PublicationSubsystem → AuditLog (entity) : записать действие «HideArticle».

* **ШАГ 60** – *Отобразить подтверждение*  
  PublicationSubsystem → AdminCenter : вернуть статус успеха.  
  AdminCenter → UI : показать сообщение «Статья успешно скрыта».  

* **Успешный результат** – ШАГ 60 завершён, цель достигнута.

== Альтернативы  

* **[ШАГ 40A]** – *Статус статьи не «Активна»*  
  - ШАГ 40 (сохранение) → ArticleService проверяет `status`.  
  - Если статус ≠ «Активна», сервис возвращает ошибку 400.  
  - UI отображает сообщение «Статья должна быть в статусе «Активна» для скрытия».  
  - Завершение сценария в неуспешном финальном состоянии.

* **[ШАГ 30A]** – *Флаг уже установлен*  
  - При попытке установить галочку, ArticleForm проверяет текущий `hideFlag`.  
  - Если `hideFlag = true`, UI выводит предупреждение «Статья уже скрыта».  
  - Пользователь может отменить действие.  
  - Сценарий завершается в неуспешном финальном состоянии.

* **[ШАГ 50A]** – *Ошибка обновления индекса видимости*  
  - PublicationSubsystem при вызове `обновитьИндексВидимости` получает исключение.  
  - Транзакция откатывается, сервис возвращает ошибку 500.  
  - UI показывает сообщение «Не удалось обновить индекс видимости».  
  - Сценарий завершается в неуспешном финальном состоянии.

== Расширения  

* **[Р‑40.1]** – *Подтверждение действия перед сохранением* (opt)  
  - После ШАГ 30, перед ШАГ 40 система выводит модальное окно «Вы уверены, что хотите скрыть статью?».  
  - Пользователь подтверждает → продолжается ШАГ 40.  
  - Отказ → возврат к ШАГ 30.

* **[Р‑60.1]** – *Инвалидация кеша* (opt)  
  - Если включён кеш‑менеджер, PublicationSubsystem вызывает `инвалидацияКеша()` после обновления индекса.  
  - При отсутствии кеша шаг пропускается без влияния на основной поток.

--- 

*НАРРАТИВ* (для контекста)  
Редактор открывает Центр администрирования, переходит к списку статей, выбирает нужную запись, отмечает флажок «Скрыть на портале» и сохраняет изменения. Система проверяет, что статья находится в статусе «Активна», сохраняет флаг, обновляет индекс видимости, инвалидирует кеш и фиксирует действие в журнале аудита. После этого статья исключается из результатов поиска и рубрикатора Портала ЕБЗ; при прямом обращении по URL пользователь получает страницу ошибки «Статья скрыта». При снятии флага статья вновь становится видимой.
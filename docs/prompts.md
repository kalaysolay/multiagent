# Промпты агентов

Все агенты загружают шаблоны промптов из БД через `PromptService.getByCode(...)`. Сидирование (начальное заполнение) выполняется при старте приложения в `PromptDataInitializer`.

## Справочник кодов промптов

| Код промпта | Сервис / агент | Назначение |
|-------------|----------------|------------|
| `narrative_writer` | NarrativeWriterService | Генерация нарратива по цели пользователя |
| `mvc_modeller` | MVCModellerService | Диаграмма пригодности (Robustness), в т.ч. при декомпозиции Use Case |
| `usecase_modeller` | UseCaseModellerService | Диаграмма прецедентов (Use Case) |
| `scenario_writer` | ScenarioWriterService | Сценарий Use Case по Алистару Коберну |
| `evaluator_plantuml` | EvaluatorService | Ревью доменной модели (PlantUML) |
| `evaluator_narrative` | EvaluatorService | Ревью нарратива |
| `domain_modeller_system` | DomainModellerService | Системный промпт для генерации/уточнения доменной модели |
| `domain_modeller_generate` | DomainModellerService | Пользовательский промпт для генерации доменной модели |
| `domain_modeller_refine` | DomainModellerService | Пользовательский промпт для уточнения модели по замечаниям |

Дополнительно в БД сидируется `orchestrator_plan` (план оркестратора); агентские промпты перечислены выше.

## Единый сценарий вызова

1. **Загрузка шаблона** — из БД по коду: `promptService.getByCode("код")`.
2. **Подстановка параметров** — в шаблон подставляются нарратив, модели, RAG-контекст и т.д. (плейсхолдеры `%s` или иной механизм в зависимости от сервиса). При необходимости выполняется экранирование (как в существующих сервисах).
3. **Вызов LLM** — один запрос с полученным промптом (user message; где используется system — как в DomainModellerService).
4. **Fallback** — для шаблонов с плейсхолдерами при несоответствии количества `%s` в NarrativeWriterService используется запасной шаблон из кода или логируется предупреждение. Для остальных агентов в рамках текущего рефакторинга отдельный fallback не вводится.

Итог: один и тот же подход «БД → подстановка → LLM» у всех агентов; единственная явная политика fallback при некорректном/пустом шаблоне — в NarrativeWriterService.

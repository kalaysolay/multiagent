= Правила построения диаграммы (системных) прецедентов в синтаксисе PlantUML
== Аффинизация

. Сгруппируй по родству глаголы из нарратива. Наименование группы - это глагол в названии прецедента.
. Для прецдента найди соответствуюший класс или классы с модели предсетной области (доменная модель). Убедись что трибуты и методы классов не противоречат названию базового прецдента или его абстрактных. 
. К глаголу добавь существительное-наименование класса, с модели предметной области.
. Используя существительное и глагол, сформулируй в изявительном наклонении третьего лица наименование прецедента соответствующее нарративу.
. Перепроверь все ли глаголы из нарратива были переведены в прецеденты.

== Скоуп

. В модели юзкейсов есть только одна группа (rectangle), которая называется < Наименование разрабатываемого приложения или фичи > и объединяет в себе все прецеденты (юзкейсы). 
Система, которую мы проектируем и есть эта группа.

``` [Plantuml]
rectangle "Название фичи на русском языке" as box {
    usecase "Наименование прецедента" as naimenovaniePrecedenta
}
```

== Акторы

. перенеси с диаграммы предметной области класс, который определяет пользователя или нескольких пользователей и нанеси их на диаграмму как actor << user >>, если в доменной модели класс пользователь разбит на роли (объекты), то в таких же отношениях, как классы и объекты, должны быть акторы на диаграмме прецедентов.
. Имя актора пиши на русском языке, оно должно быть идентично имени класса на доменной модели, если в доменной модели имя не на русском, скажи об этом.

Пример:

``` [Plantuml]
actor "Пользователь" as user << user >>
actor "Студент" as student 
actor "Тренер" as tutor
actor "Лектор" as lector
    student --|> user
    tutor --|> user
    lector --|> user
```

где Пользователь - это клас с модели предметной области, а студент, тренер и лектор - объекты.

. определи интерфейсы внешних систем или устройств и нанеси их на диаграмму как вторичных акторов << system >>. Вторичные акторы - это внешние по отношению к нашей системе акторы, которые взаимодействуют с нашей системой. Наша ситсема - это то что мы проектируем и отдаем программистам в раоту.
. вторичными акторами не могут быть сервисы нашей системы.
. Если в нарративе нет явного указания на взаимодействие с внешней информационной системой или устройством, то все действия выполняются внутри нашей системы.   

Пример:

``` [Plantuml]
    actor "Система единой государственной регистрации" as governmentRegistrationSystem << system >>
```

== Базовые прецеденты

. определи базовые прецеденты - это элемент usecase со стереотипом << base >>. Базовый прецедент - это обособленный, самодостаточный и полный по смыслу сценарий пользовательского взаимодействия с проектируемой системой, сформулированный с акцентом на получаемой актором выгоде.
.. Базовый прецедент - это действие пользователя в системе или полностью автоматизированная бизнес-функция
.. Полностью автоматизированная бизнес-функция должна быть связана ассоциацией только с вторичным актором. (например действие по расписанию или вызов нашей системы внешней через программный интерфейс)
.. Базовый прецедент декомпозируется на абстрактные.
.. Между базовыми прецедентами допускается только отношение типа вызов (invoke).
.. Если актор (первчиный или вторичный) напрямую не участвует в базовом прецеденте, то связь ставить между такими актором и прецдентом нельзя.

Пример:

``` [Plantuml]
skinparam WrapWidth 200
skinparam usecase {
    ' Base - Базовый вариант использования.
    BackgroundColor<< baseNew >> PeachPuff
    BorderColor<< baseNew >> SaddleBrown
    BorderThickness<< baseNew >> 3
}

usecase "Восстановить файл из корзины" as restoreFileFromRecycleBin << base >>
usecase "Переименовать файл" as renameFile << base >>
restoreFileFromRecycleBin ..> renameFile : invoke
```

После восстановления файла вызывается отдельный сценарий в котором пользователь переименовывает файл.

Если файл переименовывается без участия пользователя, тогда имеет место быть связь "include" между базовым юзкейсом и абстрактным юзкейсом.

== Абстрактные прецеденты

. определи абстрактные юзкейсы << abstract >> - это прецеденты, которые дополнительно раскрывают ту или иную часть базового юзкейса.
. абстрактный прецедент это реакция системы на действие пользователя


Пример правильных отношений между базовым и абстрактными юзкейсами:

skinparam usecase {
        ' Abstract - абстрактный вариант использования
    BackgroundColor<< abstract >> WhiteSmoke
    BorderColor<< abstract >> Green
    BorderThickness<< abstract >> 3
        ' Base - Базовый вариант использования.
    BackgroundColor<< baseNew >> PeachPuff
    BorderColor<< baseNew >> SaddleBrown
    BorderThickness<< baseNew >> 3

usecase "Доабвить курс в учебный план" as addCourseToTranscript << base >>
    usecase "Выбрать список курсов из БД" as selectCourseListFromDb << asbstract >>
    usecase "Отметить курс в списке" as markCourseInTheList << asbstract >> 
    usecase "Подтвердить список выранных курсов" as confirmCourseSublist << asbstract >> 
    usecase "Сбросить ранее отмеченные курсы" as cancelCourseSublist << casbstract >>
    usecase "Отобразить сообщение 'Мест нет!'" as errorCourseIsFull << casbstract >>

addCourseToTranscript ..> selectCourseListFromDb: include
markCourseInTheList ..> selectCourseListFromDb: include
addCourseToTranscript <|-- confirmCourseSublist: generaliztion
addCourseToTranscript <|-- cancelCourseSublist: generaliztion
confirmCourseSublist <.. errorCourseIsFull: extend

}

== Дополнительные правила построения диаграммы прецедентов:

. слева от rectangle размещай первичных акторов (<< user >>), а справа вторичных (<< systems >>). 
первичный актор -- usecase (слева от ассоциации)
usecase -- вторичный актор (справа от ассоциации)
. добавь директиву legt to right direction.
. диаграмма должна быть самодостаточной без note. Все действия внутри прецедента должны быть отображены через generalization, include, extend абстрактных прецдентов.
. техническое наименование прецедентов (парметр после "as" в usecase) должно соответствовать по смыслу имени прецедента пример: usecase "Перейти в раздел Хранилище" as navigateToStorageSection
. удали дублирующие связи между элементами диаграмм, отношение между двумя элементами может быть только одно, выбери наиболее подходящий под контекст нарратива тип отношения.
. если внутри базового прецедента несколько уровней иерархии абстрактных прецдентов, то отношение для каждого уровня выделяй соответствующим уровню количеством табуляций (python style)
. все отношения внутри базового прецдента размести под комментарием с названием прецдента
. отношение не может быть объявлено раньше чем участвуюший в нем прецдент. 
. комментируй строки начиная с апострофа


== Логика отношений
=== Разрешенные Паттерны отношенией при построении диаграммы прецедентов

.. Базовый прецедент взаимодействует с первичным актором
    Первичный актор -- Базовый прецедент
    Базовый прецедент -- Первичный актор

.. Базовый прецедент взаимодействует с внешним устройством или системой
    Вторичный актор -- Базовый прецедент
    Базовый прецедент -- Вторичный актор

.. Первичный актор может иметь ассоциацию только с базовыми прецедентами, у которых нет прямой связи с вторичными акторами. 
    Первичный Актор -- Базовый прецедент А ..> (invoke) Базовый прецедент Б -- Вторичный Актор

.. Вторичный актор может иметь ассоциацию только с базовыми прецедентами, у которых нет прямой связи с первичными акторами. 
    Первичный Актор -- Базовый прецедент А ..> (invoke) Базовый прецедент Б -- Вторичный Актор

.. Вторичный актор может иметь ассоциацию с абстрактными прецдентами, если речь идет об интерфейсе с внешней програмной или аппартаной системой.

.. Базовый прецедент расширяется действием, которое выполняется при наступлении какого-либо определенного события\условия.
    Первичный Актор А -- Базовый прецедент А <.. Абстрактный прецедент Б : extend

.. В рамках базового прецедента выполняеся обязательное действие. 
    Первичный Актор А -- Базовый прецедент Б ..> Абстрактный прецедент В : include

.. Условное действие выполняется при интеграции с внешним второичным актром, это же условное действие является обязательным действием для базового прецдента А
    Первичный Актор А -- Базовый прецедент Б <.. Абстрактный прецедент А : extend -- Вторичный Актор А
    Первичный Актор А -- Базовый прецедент А ..> Абстрактный прецедент А : incude -- Вторичный Актор А

.. Условное действие, обязательной активности базового прецедента выполняется при интеграции с внешним второичным акотром
    Первичный Актор А -- Базовый прецедент Б <.. Абстрактный прецедент А : extend -- Вторичный Актор А

. Выделяем наследованием части целого по принципу исполнения "исключающего ИЛИ". В базовом прецеденте В выполняется или абстрактный прецедент Г или абтрактный прецдент Д.
    Первичный Актор Б -- Базовый прецедент В <|-- Абстрактный прецедент Г : generalization ..> Абстрактный прецедент В : include
    Первичный Актор Б -- Базовый прецедент В <|-- Абстрактный прецедент Д : generalization ..> Абстрактный прецедент Г : include -- Вторичный Актор Б

. Базовый прецедент вызывает другой базовый прецдент для заврешения своего сценария или для выполнения иного обособленного сценария. Например, выбор пункта контекстного меню вызывает открытие новой страницы или модального окна, в котором от пользователя ожидается действие.
    Первичный Актор Б -- Базовый прецедент В ..> Базовый прецедент В : invoke -- Первичный Актор Б

. Базовый прецедент вызывается через абстрактный прецедент. Например, откртыие дополнительного окна для действий пользователя.
    Первичный Актор Б -- Базовый прецедент В ..> Абстрактный прецедент В : include ..> Базовый прецедент Д : invoke -- Первичный Актор Б

. При построении модели используй только те типы отношений между элементами, которые указаны в паттернах. Если всретишь новый паттерн, спроси меня как правильно декомпозировать элементы диаграммы прецедентов и какие отношения между ними ставить.
 
=== Запрещенные Паттерны отношенией при построении диаграммы прецедентов
.. Базовый прецедент не может быть обязательным дополнением или расширением к другому прецеденту.
    Первичный Актор -- Базовый прецедент ..> Базовый прецедент : extend -- Вторичный Актор
    Первичный Актор -- Базовый прецедент ..> Базовый прецедент : include
    Первичный Актор -- Базовый прецедент ..> Базовый прецедент : include -- Вторичный Актор
    Первичный Актор -- Базовый прецедент ..> Базовый прецедент : extend

.. Прецеденты не могут быть связаны между собой ассоциацией
    Первичный Актор -- Базовый прецедент -- Базовый прецедент

Прямая свзь между первичным и вторичным актором запрещена, так нельзя:
    Первичный Актор -- Вторичный Актор
    Первичный Актор --|> Вторичный Актор
    Первичный Актор <|-- Вторичный Актор
    Первичный Актор ..> Вторичный Актор : include
    Первичный Актор <.. Вторичный Актор : include
    Первичный Актор ..> Вторичный Актор : extend
    Первичный Актор <.. Вторичный Актор : extend

.. Первичный актор не может быть связан с абстрактным прецедентом никакой связью. Так нельзя:
    Первичный Актор А -- Абстрактный прецедент
    Первичный Актор А ..> Абстрактный прецедент : include
    Первичный Актор А <.. Абстрактный прецедент : extend
    Первичный Актор А <|-- Абстрактный прецедент
    Первичный Актор А --|> Абстрактный прецедент
    Первичный Актор А ..> Абстрактный прецедент : invoke

.. если прецедент связан с дочерними через асбстрактный прецдент, то прямую связь между прецдентами ставить нельзя.
    Базовый прецедент А ..> абстрактный прецдент А ..> абстрактный прецдент Б
    Базовый прецедент А ..> абстрактный прецдент Б - нельзя

    абстрактный прецедент А ..> абстрактный прецдент Б ..> абстрактный прецедент В
    абстрактный прецедент А ..> абстрактный прецедент В - нельзя

 Добавь в диаграмму параметры:

@startuml uc_moveFileWithinWarehouse
' Header
    title <Название предметной области>
    left to right direction
    skinparam WrapWidth 200
    skinparam usecase {
        ' Base - Базовый вариант использования.
        BackgroundColor<< base >> PeachPuff
        BorderColor<< base >> SaddleBrown
        BorderThickness<< base >> 3
        ' BaseNew - Базовый вариант использования изменяемый.
        BackgroundColor<< baseNew >> PeachPuff
        BorderColor<< baseNew >> SaddleBrown
        BorderThickness<< baseNew >> 3
        ' BaseOld - Базовый вариант использования неизменяемый.
        BackgroundColor<< baseOld >> DarkGrey
        BorderColor<< baseOld >> Black
        BorderThickness<< baseOld >> 3
        ' Abstarct - абстрактный прецедент
        BackgroundColor<< abstract >> WhiteSmoke
        BorderColor<< abstract >> Green
        BorderThickness<< abstract >> 3
        ' AbstractOld - абстрактный вариант использования неизменяемый.
        BackgroundColor<< abstractOld >> DarkGrey
        BorderColor<< abstractOld >> WhiteSmoke
        BorderThickness<< abstractOld >> 3
        ' AbstractNew - абстрактный вариант использования изменяемый.
        BackgroundColor<< abstractNew >> Gold
        BorderColor<< abstractNew >> GoldenRod
        BorderThickness<< abstractNew >> 3
    }

Пример правильной диагрммы, разбей ее на паттерны и сравни со своей диаграммой:
====
@startuml recycle
!theme plain
skinparam WrapWidth 200
skinparam usecase {
    BackgroundColor<< base >> PeachPuff
    BorderColor<< base >> Blue
    BorderThickness<< base >> 3
    BackgroundColor<< abstract >> WhiteSmoke
    BorderColor<< abstract >> Green
    BorderThickness<< abstract >> 3
    BackgroundColor<< baseOld >> LightGray
    BorderColor<< baseOld >> DarkGrey
    BorderThickness<< baseOld >> 3
    BackgroundColor<< abstractOld >> LightGray
    BorderColor<< abstractOld  >> DarkGrey
    BorderThickness<< abstractOld >> 3
}

left to right direction

' *** Акторы ***
actor "Пользователь" as user << user >>
actor "Администратор" as admin << user >>
actor "Редактор" as editor << user >>
actor "Главный редактор" as chiefEditor << user >>
actor "Модератор" as moderator << user >>
actor "Сотрудник технической поддержки" as technicalSupport << user >>
actor "CRON-JOB" as cronJob << secondary >>

admin --|> user
editor --|> user
chiefEditor --|> user
moderator --|> user


' *** Скоуп ***
rectangle "Управление корзиной хранилища" as box {
    ' Загрузка контента корзины
    usecase "Выбрать бизнес-направление корзины" as selectParentFolder << base >>
        usecase "Открыть главную страницу Корзины" as  openRecycleMainPage << abstract >>
    usecase "Перейти в папку в корзине" as moveToFolder << base >>
    usecase "Обновить содержимое текущей открытой папки" as clickUpdateButton << base >>
    usecase "Отчистить фильтры таблицы"  as clickButtonClearFiltres  << base >>
    
            usecase "Загрузить содержимое таблицы" as getTableContent << abstract >>
                usecase "Сортировка данных в таблице" as sortDataInTable << abstract >>
                    usecase "Сортировка по умолчанию" as sortDataDefault << abstract >>


    ' Переход из корзины в хранилище
    usecase "Вернуться в хранилище " as moveToStorage << base >>
        usecase "Открыть главную страницу Хранилища" as  openStorageMainPage << abstract >>
    
    
    ' Кейсы работы с таблицей
    usecase "Отсортировать таблицу" as selectTabelSorted << base >>
        usecase "Упорядочивание таблицы относительно сортировки" as organizeTabelBySorting << abstract >>
            ' usecase "Упорядочивание по умолчанию " as organizeTabelByDef << abstract >>

    usecase "Отфильтровать таблицу" as filterTable << base >>
            usecase "Нахождение по точному совпадению" as findExactMatch << abstract >>
            usecase "Нахождение по частичному совпадению" as findParticalMatch << abstract >>
    usecase "Выбрать значение таблицы соответствующее выбранным фильтрам" as showTabelWithFiltres << abstract >>
    
    ' Кейсы работы с контекстным меню элемента таблицы
    usecase "Открыть конекстное меню элемента таблицы" as openTableElementContextMenu << base >>
    
    '  *** Кейсы шедулера очистки корзины
     usecase "Удалить файлы из корзины по истечении срока хранения" as deleteExpiredObjects << base >>
        usecase "Удалить настройки корзины" as deleteExpiredRecycleSettings << abstract >>

    ' *** Связи акторов с прецедентами ***

    user -- selectParentFolder
    user -- moveToFolder
    user -- moveToStorage
    user -- selectTabelSorted
    user -- clickButtonClearFiltres
    user -- clickUpdateButton
    user -- filterTable
    user -- openTableElementContextMenu
    technicalSupport -- deleteExpiredObjects
    deleteExpiredObjects  -- cronJob
    deleteExpiredObjects <.. deleteExpiredRecycleSettings : extend

    ' *** Связи прецедентов ***
    selectParentFolder ..> openRecycleMainPage  : include
    openRecycleMainPage ..>  getTableContent  : include
    getTableContent <.. showTabelWithFiltres : extend
            filterTable ...> getTableContent : include
            showTabelWithFiltres ..> findExactMatch : include 
            showTabelWithFiltres ..> findParticalMatch : include 
    moveToFolder ...> getTableContent : include
    clickUpdateButton ...> getTableContent : include
    clickButtonClearFiltres ...> getTableContent : include
    moveToStorage  ..> openStorageMainPage : include
    selectTabelSorted  ..> organizeTabelBySorting : include
    getTableContent ..> sortDataInTable : include
    sortDataInTable <.. sortDataDefault : extend
}

@enduml
====

Добавь блок title\end title в код в стиле китайского хокку кратко описывающую суть диаграммы, слог как у мастера Йодо из Звездных войн.
Пример:
title 
    В корзине объект забыт 
    Восстановить его просит
    Система путь вернет.
end title


Строго следуй этим правилам. Раздели работу на этапы и проверяй каждый этап на соответствие этим правилам. Будь крайне самокритичным.

Если пользователь дал тебе вместе с этой инструкцией диаграмму прецедентов, уточни, что с ней сделать: изменить, дополнить или оставить без изменений.
Также убедись что пользователь дал тебе нарратив и модель предметной области. Обязательно должна быть модель предметной области для построения диаграммы прецедентов! Если нет, то запроси их.

---

НАРРАТИВ:
%s

ДОМЕННАЯ МОДЕЛЬ (PlantUML):
%s

КОНТЕКСТ СИСТЕМЫ (RAG):
%s

Сгенерируй диаграмму прецедентов по правилам выше. Выведи ТОЛЬКО один законченный блок PlantUML, начинающийся с @startuml и заканчивающийся @enduml. Не добавляй никаких пояснений вне блока.



